@page "/weather"
@rendermode InteractiveServer
@using RecipeSearchWeb.Services
@inject WeatherService WeatherService

<PageTitle>Weather</PageTitle>

<div class="weather-container">
    <div class="weather-header">
        <h1 class="weather-title">
            <span class="weather-emoji">⛅</span>
            7-Day Weather Forecast
        </h1>
        @if (!string.IsNullOrEmpty(locationName))
        {
            <p class="weather-subtitle">📍 @locationName</p>
        }
        else
        {
            <p class="weather-subtitle">Your local weather at a glance</p>
        }
    </div>

    @if (isLoading)
    {
        <div class="loading-section">
            <div class="loading-spinner-large"></div>
            <p class="loading-text">Detecting your location and loading forecast...</p>
        </div>
    }
    else if (forecasts == null || !forecasts.Any())
    {
        <div class="error-section">
            <p>Unable to load weather data. Please try again later.</p>
        </div>
    }
    else
    {
        <div class="weather-grid">
            @foreach (var forecast in forecasts)
            {
                <div class="weather-card @GetWeatherClass(forecast.TemperatureMax)">
                    <div class="weather-card-header">
                        <div class="weather-icon">@RecipeSearchWeb.Services.WeatherService.GetWeatherEmoji(forecast.WeatherCode)</div>
                        <div class="weather-date">
                            <div class="day-name">@forecast.Date.ToString("dddd")</div>
                            <div class="date-info">@forecast.Date.ToString("MMM dd")</div>
                        </div>
                    </div>
                    <div class="weather-card-body">
                        <div class="temperature-section">
                            <div class="temp-main">@forecast.TemperatureMax°</div>
                            <div class="temp-label">High</div>
                            <div class="temp-unit">Celsius</div>
                        </div>
                        <div class="temp-divider"></div>
                        <div class="temperature-section">
                            <div class="temp-main">@forecast.TemperatureMin°</div>
                            <div class="temp-label">Low</div>
                            <div class="temp-unit">Celsius</div>
                        </div>
                    </div>
                    <div class="weather-card-footer">
                        <span class="weather-summary">@RecipeSearchWeb.Services.WeatherService.GetWeatherDescription(forecast.WeatherCode)</span>
                    </div>
                </div>
            }
        </div>
    }
</div>

@code {
    private List<DailyForecast>? forecasts;
    private string locationName = string.Empty;
    private bool isLoading = true;

    protected override async Task OnInitializedAsync()
    {
        try
        {
            // Get user's location from IP
            var location = await WeatherService.GetLocationFromIpAsync();
            
            if (location != null)
            {
                locationName = $"{location.City}, {location.Country}";
                
                // Get weather forecast for the location
                var weatherData = await WeatherService.GetWeatherForecastAsync(location.Latitude, location.Longitude);
                
                if (weatherData != null)
                {
                    forecasts = weatherData.Forecasts;
                }
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading weather: {ex.Message}");
        }
        finally
        {
            isLoading = false;
        }
    }

    private string GetWeatherClass(int temperature)
    {
        return temperature switch
        {
            <= 5 => "weather-cold",
            <= 15 => "weather-mild",
            <= 25 => "weather-warm",
            _ => "weather-hot"
        };
    }
}
